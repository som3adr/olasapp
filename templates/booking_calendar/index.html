{% extends "base.html" %}

{% block title %}Booking Calendar - HostelFlow{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-calendar-alt me-2"></i>Booking Calendar</h2>
                <div>
                    <a href="{{ url_for('booking_calendar.occupancy_report') }}" class="btn btn-info me-2">
                        <i class="fas fa-chart-bar me-1"></i>Occupancy Report
                    </a>
                    <a href="{{ url_for('checkin.index') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>New Booking
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Navigation -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('booking_calendar.index', year=prev_year, month=prev_month) }}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-chevron-left me-1"></i>Previous
                        </a>
                        <h3 class="mb-0">{{ month_name }} {{ year }}</h3>
                        <a href="{{ url_for('booking_calendar.index', year=next_year, month=next_month) }}" 
                           class="btn btn-outline-primary">
                            Next<i class="fas fa-chevron-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-calendar me-2"></i>Monthly Overview</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered calendar-table">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-center">Monday</th>
                                    <th class="text-center">Tuesday</th>
                                    <th class="text-center">Wednesday</th>
                                    <th class="text-center">Thursday</th>
                                    <th class="text-center">Friday</th>
                                    <th class="text-center">Saturday</th>
                                    <th class="text-center">Sunday</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for week in calendar %}
                                <tr>
                                    {% for day in week %}
                                    <td class="calendar-day {% if day == 0 %}empty-day{% endif %}" 
                                        {% if day > 0 %}data-date="{{ year }}-{{ '%02d'|format(month) }}-{{ '%02d'|format(day) }}"{% endif %}>
                                        {% if day > 0 %}
                                        {% set date_str = year ~ '-' ~ '%02d'|format(month) ~ '-' ~ '%02d'|format(day) %}
                                        {% set day_data = availability_data.get(date_str, {}) %}
                                        
                                        <div class="day-header">
                                            <strong>{{ day }}</strong>
                                            {% if day_data %}
                                            <small class="occupancy-badge 
                                                {% if day_data.occupancy_rate >= 90 %}bg-danger
                                                {% elif day_data.occupancy_rate >= 70 %}bg-warning
                                                {% elif day_data.occupancy_rate >= 40 %}bg-info
                                                {% else %}bg-success{% endif %} text-white rounded px-1">
                                                {{ "%.0f"|format(day_data.occupancy_rate) }}%
                                            </small>
                                            {% endif %}
                                        </div>
                                        
                                        {% if day_data %}
                                        <div class="day-content">
                                            <small class="text-muted">
                                                {{ day_data.occupied_beds }}/{{ day_data.total_beds }} beds
                                            </small>
                                            
                                            {% if day_data.checkins %}
                                            <div class="checkins">
                                                {% for checkin in day_data.checkins[:2] %}
                                                <div class="badge bg-success mb-1">
                                                    <i class="fas fa-sign-in-alt"></i> {{ checkin.tenant.name[:10] }}
                                                </div>
                                                {% endfor %}
                                                {% if day_data.checkins|length > 2 %}
                                                <div class="badge bg-success">+{{ day_data.checkins|length - 2 }} more</div>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            
                                            {% if day_data.checkouts %}
                                            <div class="checkouts">
                                                {% for checkout in day_data.checkouts[:2] %}
                                                <div class="badge bg-danger mb-1">
                                                    <i class="fas fa-sign-out-alt"></i> {{ checkout.tenant.name[:10] }}
                                                </div>
                                                {% endfor %}
                                                {% if day_data.checkouts|length > 2 %}
                                                <div class="badge bg-danger">+{{ day_data.checkouts|length - 2 }} more</div>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="day-actions mt-2">
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="showDayDetails('{{ date_str }}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if day_data.available_beds > 0 %}
                                            <button class="btn btn-sm btn-success" 
                                                    onclick="quickBook('{{ date_str }}')">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rooms Quick View -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bed me-2"></i>Rooms Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for room in rooms %}
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        Room {{ room.room_number }}
                                        <small class="text-muted">(Capacity: {{ room.capacity }})</small>
                                    </h6>
                                    <p class="card-text">
                                        <strong>{{ room.beds|length }} beds</strong>
                                        <br>
                                        <small class="text-muted">{{ room.beds|sum(attribute='places') }} total places</small>
                                    </p>
                                    <div class="bed-status">
                                        {% for bed in room.beds %}
                                        <span class="badge me-1 mb-1 
                                            {% if bed.tenant_id %}bg-danger{% else %}bg-success{% endif %}">
                                            Bed {{ bed.bed_number }}
                                            {% if bed.tenant_id %}
                                            <br><small>{{ bed.tenant.name if bed.tenant else 'Occupied' }}</small>
                                            {% endif %}
                                        </span>
                                        {% endfor %}
                                    </div>
                                    <div class="mt-2">
                                        <a href="{{ url_for('booking_calendar.room_calendar', room_id=room.id) }}" 
                                           class="btn btn-sm btn-primary">
                                            <i class="fas fa-calendar-alt"></i> View Calendar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Day Details Modal -->
<div class="modal fade" id="dayDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-calendar-day me-2"></i>Day Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="dayDetailsContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Book Modal -->
<div class="modal fade" id="quickBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Quick Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('booking_calendar.quick_book') }}">
                <div class="modal-body">
                    <input type="hidden" id="quick-book-date" name="check_in_date">
                    
                    <div class="mb-3">
                        <label for="quick-bed-id" class="form-label">Available Bed</label>
                        <select class="form-select" id="quick-bed-id" name="bed_id" required>
                            <option value="">Select a bed...</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quick-guest-name" class="form-label">Guest Name *</label>
                        <input type="text" class="form-control" id="quick-guest-name" name="guest_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quick-guest-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="quick-guest-email" name="guest_email">
                    </div>
                    
                    <div class="mb-3">
                        <label for="quick-guest-phone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="quick-guest-phone" name="guest_phone">
                    </div>
                    
                    <div class="mb-3">
                        <label for="quick-daily-rate" class="form-label">Daily Rate *</label>
                        <input type="number" step="0.01" class="form-control" id="quick-daily-rate" name="daily_rate" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>Book Now
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.calendar-table {
    font-size: 0.85rem;
}

.calendar-day {
    height: 120px;
    vertical-align: top;
    position: relative;
    padding: 5px;
}

.empty-day {
    background-color: #f8f9fa;
}

.day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.day-content {
    min-height: 60px;
    font-size: 0.75rem;
}

.day-actions {
    position: absolute;
    bottom: 5px;
    right: 5px;
}

.occupancy-badge {
    font-size: 0.7rem;
}

.checkins, .checkouts {
    margin-bottom: 2px;
}

.bed-status .badge {
    font-size: 0.7rem;
}
</style>

<script>
function showDayDetails(date) {
    const modal = new bootstrap.Modal(document.getElementById('dayDetailsModal'));
    const content = document.getElementById('dayDetailsContent');
    
    // Show loading
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Fetch availability data
    fetch(`/booking-calendar/api/availability/${date}`, {
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            let html = `<h6>Availability for ${data.date}</h6>`;
            
            data.rooms.forEach(room => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Room ${room.room_number}</strong> (Capacity: ${room.capacity})
                        </div>
                        <div class="card-body">
                            <div class="row">
                `;
                
                room.beds.forEach(bed => {
                    const statusClass = bed.is_occupied ? 'bg-danger' : 'bg-success';
                    const statusText = bed.is_occupied ? 'Occupied' : 'Available';
                    const guestInfo = bed.guest ? `<br><small>${bed.guest.name}</small>` : '';
                    
                    html += `
                        <div class="col-md-6 mb-2">
                            <div class="badge ${statusClass} w-100 p-2">
                                Bed ${bed.bed_number} (${bed.places} places)
                                <br>${statusText}
                                ${guestInfo}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        })
        .catch(error => {
            content.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
        });
}

function quickBook(date) {
    document.getElementById('quick-book-date').value = date;
    
    // Fetch available beds for this date
    fetch(`/booking-calendar/api/availability/${date}`, {
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            const bedSelect = document.getElementById('quick-bed-id');
            bedSelect.innerHTML = '<option value="">Select a bed...</option>';
            
            data.rooms.forEach(room => {
                room.beds.forEach(bed => {
                    if (!bed.is_occupied) {
                        const option = document.createElement('option');
                        option.value = bed.id;
                        option.textContent = `Room ${room.room_number}, Bed ${bed.bed_number} (${bed.places} places)`;
                        bedSelect.appendChild(option);
                    }
                });
            });
            
            const modal = new bootstrap.Modal(document.getElementById('quickBookModal'));
            modal.show();
        })
        .catch(error => {
            alert('Error loading available beds: ' + error.message);
        });
}
</script>
{% endblock %}
