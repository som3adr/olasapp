{% extends "base.html" %}

{% block title %}Employee Salaries - HostelFlow{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-users-cog text-primary me-2"></i>
                Employee Salaries
            </h1>
            <p class="text-muted">Manage employee information and salary records</p>
        </div>
        <div>
            <a href="{{ url_for('employee_salaries.add_employee') }}" class="btn btn-primary me-2">
                <i class="fas fa-plus"></i> Add Employee
            </a>
            <a href="{{ url_for('employee_salaries.advances') }}" class="btn btn-warning me-2">
                <i class="fas fa-money-bill-wave"></i> Salary Advances
            </a>
            <a href="{{ url_for('employee_salaries.export_salaries', month=current_month) }}" class="btn btn-success">
                <i class="fas fa-download"></i> Export CSV
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Employees
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_employees }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Active Employees
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ active_employees }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Payroll
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ "%.2f"|format(total_payroll) }} MAD</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-money-bill-wave fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Paid Salaries
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ paid_salaries }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Filters & Search</h6>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="month" class="form-label">Month</label>
                    <input type="month" class="form-control" id="month" name="month" value="{{ current_month }}">
                </div>
                <div class="col-md-2">
                    <label for="department" class="form-label">Department</label>
                    <select class="form-select" id="department" name="department">
                        <option value="all" {% if current_department == 'all' %}selected{% endif %}>All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}" {% if current_department == dept %}selected{% endif %}>{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="all" {% if current_status == 'all' %}selected{% endif %}>All Status</option>
                        <option value="active" {% if current_status == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if current_status == 'inactive' %}selected{% endif %}>Inactive</option>
                        <option value="terminated" {% if current_status == 'terminated' %}selected{% endif %}>Terminated</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="search" class="form-label">Search</label>
                    <input type="text" class="form-control" id="search" name="search" 
                           value="{{ current_search }}" placeholder="Name, code, or position">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Filter
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Department Statistics -->
    <div class="row mb-4">
        {% for dept, stats in dept_stats.items() %}
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card border-left-secondary shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                        {{ dept }}
                    </div>
                    <div class="h6 mb-0 font-weight-bold text-gray-800">
                        {{ stats.count }} employees
                    </div>
                    <div class="text-xs text-gray-600">
                        {{ "%.0f"|format(stats.total_salary) }} MAD
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Employees Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Employees & Salaries</h6>
            <div>
                <button type="button" class="btn btn-sm btn-success" onclick="selectAllEmployees()">
                    <i class="fas fa-check-square"></i> Select All
                </button>
                <button type="button" class="btn btn-sm btn-warning" onclick="bulkPayModal()">
                    <i class="fas fa-money-bill-wave"></i> Bulk Pay
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="employeesTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>Employee Code</th>
                            <th>Name</th>
                            <th>Department</th>
                            <th>Position</th>
                            <th>Status</th>
                            <th>Basic Salary</th>
                            <th>Net Salary</th>
                            <th>Payment Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in employees %}
                        <tr>
                            <td>
                                <input type="checkbox" class="employee-checkbox" value="{{ employee.id }}">
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ employee.employee_code }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-placeholder me-2">
                                        <i class="fas fa-user text-primary"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ employee.full_name }}</div>
                                        <small class="text-muted">{{ employee.employment_type }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ employee.department }}</span>
                            </td>
                            <td>{{ employee.position }}</td>
                            <td>
                                {% if employee.status == 'active' %}
                                    <span class="badge bg-success">Active</span>
                                {% elif employee.status == 'inactive' %}
                                    <span class="badge bg-warning">Inactive</span>
                                {% else %}
                                    <span class="badge bg-danger">Terminated</span>
                                {% endif %}
                            </td>
                            <td>{{ "%.2f"|format(employee.basic_salary) }} MAD</td>
                            <td>
                                {% set salary_record = salary_map.get(employee.id) %}
                                {% if salary_record %}
                                    <span class="fw-bold text-success">{{ "%.2f"|format(salary_record.net_salary) }} MAD</span>
                                {% else %}
                                    <span class="text-muted">No record</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if salary_record %}
                                    {% if salary_record.payment_status == 'paid' %}
                                        <span class="badge bg-success">Paid</span>
                                    {% elif salary_record.payment_status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% else %}
                                        <span class="badge bg-danger">Failed</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">No Record</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('employee_salaries.view_employee', employee_id=employee.id) }}" 
                                       class="btn btn-sm btn-outline-info" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('employee_salaries.edit_employee', employee_id=employee.id) }}" 
                                       class="btn btn-sm btn-outline-primary" title="Edit Employee">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('employee_salaries.manage_salary', employee_id=employee.id) }}" 
                                       class="btn btn-sm btn-outline-success" title="Manage Salary">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger" title="Remove Employee" 
                                            onclick="removeEmployee({{ employee.id }}, '{{ employee.first_name }} {{ employee.last_name }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Payment Modal -->
<div class="modal fade" id="bulkPayModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Payment Processing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('employee_salaries.bulk_pay') }}">
                <div class="modal-body">
                    <!-- Hidden field to pass current month -->
                    <input type="hidden" name="month" value="{{ current_month }}">
                    
                    <div class="mb-3">
                        <label for="payment_date" class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="payment_date" name="payment_date" 
                               value="{{ date.today().strftime('%Y-%m-%d') }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Payment Method</label>
                        <select class="form-select" id="payment_method" name="payment_method" required>
                            <option value="">Select Method</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Cash">Cash</option>
                            <option value="Check">Check</option>
                        </select>
                    </div>
                    
                    <!-- Hostel Allocation Section -->
                    <div class="mb-3">
                        <label class="form-label">Hostel Budget Allocation</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="hostel_allocation" id="single_hostel" value="single" checked>
                                    <label class="form-check-label" for="single_hostel">
                                        Single Hostel
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="hostel_allocation" id="split_50_50" value="split_50_50">
                                    <label class="form-check-label" for="split_50_50">
                                        50/50 Split (Olas/Tide)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="hostel_allocation" id="custom_split" value="custom">
                                    <label class="form-check-label" for="custom_split">
                                        Custom Split
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Single Hostel Selection -->
                    <div id="single_hostel_options" class="mb-3">
                        <label for="single_hostel_name" class="form-label">Select Hostel</label>
                        <select class="form-select" id="single_hostel_name" name="single_hostel_name">
                            <option value="Olas">Olas</option>
                            <option value="Tide">Tide</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    
                    <!-- Custom Split Options -->
                    <div id="custom_split_options" class="mb-3" style="display: none;">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="olas_percentage" class="form-label">Olas %</label>
                                <input type="number" class="form-control" id="olas_percentage" name="olas_percentage" 
                                       min="0" max="100" value="50" onchange="updateCustomSplit()">
                            </div>
                            <div class="col-md-4">
                                <label for="tide_percentage" class="form-label">Tide %</label>
                                <input type="number" class="form-control" id="tide_percentage" name="tide_percentage" 
                                       min="0" max="100" value="50" onchange="updateCustomSplit()">
                            </div>
                            <div class="col-md-4">
                                <label for="general_percentage" class="form-label">General %</label>
                                <input type="number" class="form-control" id="general_percentage" name="general_percentage" 
                                       min="0" max="100" value="0" onchange="updateCustomSplit()">
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Total: <span id="total_percentage">100</span>%</small>
                        </div>
                    </div>
                    
                    <!-- Payment Summary -->
                    <div id="payment_summary" class="alert alert-success" style="display: none;">
                        <h6><i class="fas fa-calculator me-2"></i>Payment Summary</h6>
                        <div id="summary_content"></div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This will mark all selected employees' salaries as paid and create expense records for each hostel's contribution. If an employee doesn't have a salary record for this month, one will be created automatically using their basic salary.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-money-bill-wave"></i> Process Payments
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.employee-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function selectAllEmployees() {
    const checkboxes = document.querySelectorAll('.employee-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    document.getElementById('selectAll').checked = true;
}

function bulkPayModal() {
    const selectedEmployees = document.querySelectorAll('.employee-checkbox:checked');
    if (selectedEmployees.length === 0) {
        alert('Please select at least one employee.');
        return;
    }
    
    // Add hidden inputs for selected employees
    const form = document.querySelector('#bulkPayModal form');
    const existingInputs = form.querySelectorAll('input[name="employee_ids"]');
    existingInputs.forEach(input => input.remove());
    
    selectedEmployees.forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'employee_ids';
        input.value = checkbox.value;
        form.appendChild(input);
    });
    
    // Calculate and show payment summary
    calculatePaymentSummary();
    
    const modal = new bootstrap.Modal(document.getElementById('bulkPayModal'));
    modal.show();
}

// Hostel allocation functions
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for hostel allocation radio buttons
    document.querySelectorAll('input[name="hostel_allocation"]').forEach(radio => {
        radio.addEventListener('change', function() {
            toggleHostelOptions();
            calculatePaymentSummary();
        });
    });
    
    // Add event listeners for custom split inputs
    document.getElementById('olas_percentage').addEventListener('input', updateCustomSplit);
    document.getElementById('tide_percentage').addEventListener('input', updateCustomSplit);
    document.getElementById('general_percentage').addEventListener('input', updateCustomSplit);
});

function toggleHostelOptions() {
    const singleHostel = document.getElementById('single_hostel').checked;
    const customSplit = document.getElementById('custom_split').checked;
    
    document.getElementById('single_hostel_options').style.display = singleHostel ? 'block' : 'none';
    document.getElementById('custom_split_options').style.display = customSplit ? 'block' : 'none';
}

function updateCustomSplit() {
    const olas = parseInt(document.getElementById('olas_percentage').value) || 0;
    const tide = parseInt(document.getElementById('tide_percentage').value) || 0;
    const general = parseInt(document.getElementById('general_percentage').value) || 0;
    const total = olas + tide + general;
    
    document.getElementById('total_percentage').textContent = total;
    
    if (total !== 100) {
        document.getElementById('total_percentage').style.color = 'red';
    } else {
        document.getElementById('total_percentage').style.color = 'green';
    }
    
    calculatePaymentSummary();
}

function calculatePaymentSummary() {
    const selectedEmployees = document.querySelectorAll('.employee-checkbox:checked');
    if (selectedEmployees.length === 0) {
        document.getElementById('payment_summary').style.display = 'none';
        return;
    }
    
    // Get employee data from the table
    let totalSalary = 0;
    const employeeData = [];
    
    selectedEmployees.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const name = row.querySelector('td:nth-child(2)').textContent.trim();
        const salary = parseFloat(row.querySelector('td:nth-child(4)').textContent.replace(/[^\d.-]/g, '')) || 0;
        totalSalary += salary;
        employeeData.push({name, salary});
    });
    
    // Calculate allocation based on selected option
    const allocationType = document.querySelector('input[name="hostel_allocation"]:checked').value;
    let summary = `<strong>Total Salary: ${totalSalary.toFixed(2)} MAD</strong><br><br>`;
    
    if (allocationType === 'single') {
        const hostel = document.getElementById('single_hostel_name').value;
        summary += `${hostel}: ${totalSalary.toFixed(2)} MAD (100%)`;
    } else if (allocationType === 'split_50_50') {
        const olasAmount = totalSalary * 0.5;
        const tideAmount = totalSalary * 0.5;
        summary += `Olas: ${olasAmount.toFixed(2)} MAD (50%)<br>`;
        summary += `Tide: ${tideAmount.toFixed(2)} MAD (50%)`;
    } else if (allocationType === 'custom') {
        const olasPct = parseInt(document.getElementById('olas_percentage').value) || 0;
        const tidePct = parseInt(document.getElementById('tide_percentage').value) || 0;
        const generalPct = parseInt(document.getElementById('general_percentage').value) || 0;
        
        if (olasPct > 0) summary += `Olas: ${(totalSalary * olasPct / 100).toFixed(2)} MAD (${olasPct}%)<br>`;
        if (tidePct > 0) summary += `Tide: ${(totalSalary * tidePct / 100).toFixed(2)} MAD (${tidePct}%)<br>`;
        if (generalPct > 0) summary += `General: ${(totalSalary * generalPct / 100).toFixed(2)} MAD (${generalPct}%)`;
    }
    
    document.getElementById('summary_content').innerHTML = summary;
    document.getElementById('payment_summary').style.display = 'block';
}

// Remove Employee function
function removeEmployee(employeeId, employeeName) {
    document.getElementById('employeeName').textContent = employeeName;
    document.getElementById('removeForm').action = "{{ url_for('employee_salaries.remove_employee', employee_id=0) }}".replace('0', employeeId);
    
    const removeModal = new bootstrap.Modal(document.getElementById('removeEmployeeModal'));
    removeModal.show();
}
</script>

<!-- Remove Employee Confirmation Modal -->
<div class="modal fade" id="removeEmployeeModal" tabindex="-1" aria-labelledby="removeEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="removeEmployeeModalLabel">Remove Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning!</strong> This action cannot be undone.
                </div>
                <p>Are you sure you want to remove <strong id="employeeName"></strong> from the system?</p>
                <p class="text-danger"><strong>This will permanently delete:</strong></p>
                <ul class="text-danger">
                    <li>Employee information</li>
                    <li>All salary records</li>
                    <li>All salary advances</li>
                    <li>All related data</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="removeForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Remove Employee
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
